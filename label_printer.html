<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¾ ë†ì—… ì¡°ì‚¬ í†µí•© ë„êµ¬</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/olivettirda/rda/refs/heads/main/ssallogo.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/olivettirda/rda/refs/heads/main/ssallogo.png">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/moonspam/NanumSquare@2.0/nanumsquare.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; background: rgba(255, 255, 255, 0.98); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; color: white; }
        .header h1 { font-size: 28px; margin-bottom: 10px; font-weight: 700; }
        .header p { font-size: 14px; opacity: 0.9; }
        .nav-tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; padding: 0 20px; overflow-x: auto; }
        .nav-tab { padding: 15px 25px; cursor: pointer; border: none; background: none; font-size: 15px; color: #495057; transition: all 0.3s; position: relative; white-space: nowrap; }
        .nav-tab:hover { color: #667eea; }
        .nav-tab.active { color: #667eea; font-weight: 600; }
        .nav-tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 3px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .panel { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 1px solid #e9ecef; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); }
        .panel-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px; }
        .setting-label { display: inline-block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px; }
        .input-divider { text-align: center; margin: 25px 0; color: #999; font-size: 14px; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: all 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        textarea { min-height: 120px; resize: vertical; font-family: 'Courier New', monospace; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; white-space: nowrap; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; color: white; }
        .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .setting-item { display: flex; flex-direction: column; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .input-row input[type="text"] { flex: 1; }
        .input-row input[type="number"] { width: 80px; }
        .input-row .btn-remove { padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .output-section { background: #f8f9fa; border-radius: 8px; padding: 20px; min-height: 200px; margin-bottom: 20px; overflow-x: auto; }
        .output-empty { text-align: center; color: #adb5bd; padding: 40px; font-size: 14px; }
        .variety-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .variety-item { background: white; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6; font-size: 14px; text-align: center; transition: all 0.2s; }
        .variety-item:hover { border-color: #667eea; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; background: white; }
        table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 8px; text-align: center; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        table td { padding: 8px; border: 1px solid #dee2e6; text-align: center; }
        table tr:nth-child(even) { background: #f8f9fa; }
        table tr:hover { background: #e9ecef; }
        table tr.thick-bottom-border td { border-bottom: 3px solid #495057 !important; }
        table input { width: 100%; padding: 5px; border: 1px solid #dee2e6; border-radius: 4px; text-align: center; }
        table input:focus { border-color: #667eea; outline: none; }
        .chart-container { position: relative; height: 400px; margin-top: 20px; background: white; padding: 20px; border-radius: 8px; }
        .file-upload { position: relative; display: inline-block; cursor: pointer; width: 100%; }
        .file-upload input[type=file] { position: absolute; left: -9999px; }
        .file-upload-label { display: block; padding: 40px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; text-align: center; transition: all 0.3s; cursor: pointer; }
        .file-upload-label:hover { background: #e9ecef; border-color: #667eea; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .conversion-section { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .conversion-item { display: grid; grid-template-columns: 200px 100px 150px auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px; }
        .conversion-item input[type="checkbox"] { width: auto; margin-right: 10px; }
        .conversion-item select { width: auto; }
        .formula-display { font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 5px; background: #f1f3f5; border-radius: 4px; }
        .two-column-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .display-label-item { position: relative; overflow: hidden; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-family: 'NanumSquare', sans-serif; font-weight: 800; display: flex; align-items: center; justify-content: center; }
        .display-label-small { width: 75mm; height: 40mm; padding: 0 5mm; }
        .display-label-medium { width: 75mm; height: 50mm; padding: 0 5mm; }
        .display-label-large { width: 150mm; height: 75mm; padding: 0 20mm; }
        .label-name { font-size: 36pt; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        .label-desc { margin-top: 2mm; font-size: 18pt; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        .display-label-large .label-name { font-size: 72pt; }
        .display-label-large .label-org { margin-top: 5mm; font-size: 24pt; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        .display-label-content { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        .text-bg-white { background-color: rgba(255, 255, 255, 0.9); padding: 5mm; border-radius: 3mm; }
        .text-bg-black { background-color: rgba(0, 0, 0, 0.7); padding: 5mm; border-radius: 3mm; color: white; }
        .text-bg-blur { backdrop-filter: blur(5px); background-color: rgba(255, 255, 255, 0.3); padding: 5mm; border-radius: 3mm; }
        .barcode-label-container { width: 210mm; min-height: 297mm; padding: 12mm 5mm; background: white; margin: 0 auto; }
        .barcode-label-grid { display: grid; grid-template-columns: repeat(3, 64mm); grid-template-rows: repeat(8, 34mm); gap: 0 2mm; width: 100%; }
        .barcode-label-grid-21 { display: grid; grid-template-columns: repeat(3, 64mm); grid-template-rows: repeat(7, 39mm); gap: 0 2mm; width: 100%; }
        .qr-label-item { width: 64mm; height: 34mm; border: 1px solid #ccc; padding: 2mm; display: flex; align-items: center; overflow: hidden; box-sizing: border-box; font-family: 'NanumSquare', sans-serif; }
        .qr-label-item-39 { height: 39mm; }
        .qr-label-left { width: 20mm; height: 20mm; display: flex; align-items: center; justify-content: center; margin-right: 2mm; flex-shrink: 0; }
        .qr-code-container { width: 20mm; height: 20mm; display: flex; align-items: center; justify-content: center; }
        .qr-code-container canvas, .qr-code-container img { max-width: 100%; max-height: 100%; width: auto !important; height: auto !important; }
        .qr-label-right { flex: 1; display: flex; flex-direction: column; justify-content: center; padding-right: 5mm; padding-left: 2mm; min-width: 0; }
        .qr-test-number { font-size: 18pt; font-weight: bold; line-height: 1; margin-bottom: 1mm; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .qr-variety-name { font-size: 9pt; line-height: 1; margin-bottom: 1mm; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .qr-sample-number { font-size: 8pt; font-family: 'Courier New', monospace; color: #666; line-height: 1; white-space: nowrap; }
        @media (max-width: 768px) { .two-column-layout { grid-template-columns: 1fr; } .conversion-item { grid-template-columns: 1fr; } }
        @media print { body { background: white; padding: 0; } .container { box-shadow: none; } .nav-tabs, .header, .btn, .actions { display: none !important; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ¾ ë†ì—… ì¡°ì‚¬ í†µí•© ë„êµ¬</h1>
            <p>í’ˆì¢… ëª©ë¡ ìƒì„±, ìƒìœ¡ì¡°ì‚¬, ë°ì´í„° ë¶„ì„ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab(event, 'list')">ğŸ“‹ í’ˆì¢…ëª©ë¡ ìƒì„±</button>
            <button class="nav-tab" onclick="switchTab(event, 'survey')">ğŸ“ ìƒìœ¡ì¡°ì‚¬ ì–‘ì‹</button>
            <button class="nav-tab" onclick="switchTab(event, 'analysis')">ğŸ“Š ë°ì´í„° ë¶„ì„</button>
            <button class="nav-tab" onclick="switchTab(event, 'label')">ğŸ·ï¸ ë¼ë²¨ ì¶œë ¥</button>
        </div>

        <div class="content">
            <!-- í’ˆì¢…ëª©ë¡ ìƒì„± íƒ­ -->
            <div id="listTab" class="tab-content active">
                <div class="two-column-layout">
                    <div class="panel">
                        <div class="panel-title">ğŸ“ í’ˆì¢… ì…ë ¥</div>
                        
                        <div class="form-group">
                            <label>ì§ì ‘ ì…ë ¥</label>
                            <div id="varietyInputs"></div>
                            <button class="btn btn-info" onclick="addInputRow()">+ í’ˆì¢… ì¶”ê°€</button>
                        </div>

                        <div class="input-divider">ë˜ëŠ”</div>

                        <div class="form-group">
                            <label>í…ìŠ¤íŠ¸ ì¼ê´„ ì…ë ¥</label>
                            <textarea id="bulkInput" placeholder="í•œì•„ë¦„&#10;ìƒˆì¼ë¯¸&#10;ì‚¼ê´‘"></textarea>
                            <div style="margin-top: 10px;">
                                <label class="setting-label">ê¸°ë³¸ ë°˜ë³µìˆ˜</label>
                                <input type="number" id="defaultRepeatCount" value="3" min="1" max="20" style="width: 100px;">
                            </div>
                        </div>

                        <div class="input-divider">ë˜ëŠ”</div>

                        <div class="form-group">
                            <label>ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</label>
                            <div class="file-upload">
                                <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelUpload(event)">
                                <label for="excelFile" class="file-upload-label" id="excelLabel">
                                    ğŸ“‚ í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ<br>
                                    <small>ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸</small>
                                </label>
                            </div>
                        </div>

                        <div class="actions">
                            <button class="btn btn-secondary" onclick="downloadListTemplate()">ğŸ“¥ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
                            <button class="btn btn-primary" onclick="generateList()" style="padding: 12px 30px; font-size: 16px;">
                                ğŸ“‹ í’ˆì¢… ëª©ë¡ ìƒì„±
                            </button>
                            <button class="btn btn-warning" onclick="clearInputs()">ğŸ”„ ì´ˆê¸°í™”</button>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-title">ğŸ“‹ ìƒì„±ëœ ëª©ë¡</div>
                        
                        <div class="output-section" id="listOutput">
                            <div class="output-empty">í’ˆì¢…ì„ ì…ë ¥í•˜ê±°ë‚˜ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•œ í›„<br>'ëª©ë¡ ìƒì„±' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                        </div>

                        <div class="actions">
                            <button class="btn btn-secondary" onclick="copyListToClipboard()">ğŸ“‹ ë³µì‚¬í•˜ê¸°</button>
                            <button class="btn btn-secondary" onclick="downloadListExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                            <button class="btn btn-secondary" onclick="downloadListCSV()">ğŸ’¾ CSV ë‹¤ìš´ë¡œë“œ</button>
                            <button class="btn btn-danger" onclick="clearListOutput()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìƒìœ¡ì¡°ì‚¬ ì–‘ì‹ íƒ­ -->
            <div id="surveyTab" class="tab-content">
                <div class="panel">
                    <div class="panel-title">âš™ï¸ ê¸°ë³¸ ì„¤ì •</div>
                    
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">ë°˜ë³µ ìˆ˜</label>
                            <input type="number" id="repeatCount" placeholder="ë°˜ë³µ ìˆ˜ ì…ë ¥" min="1" max="20">
                        </div>
                        
                        <div class="setting-item">
                            <label class="setting-label">ì¡°ì‚¬ í•­ëª© ì„¸íŠ¸</label>
                            <select id="surveyType" onchange="updateSurveyItems()">
                                <option value="basic">ê¸°ë³¸ (ê°„ì¥, ìˆ˜ì¥, ìˆ˜ìˆ˜)</option>
                                <option value="heading">ê¸°ë³¸ + ì¶œìˆ˜ê¸°</option>
                                <option value="yield">ìˆ˜ëŸ‰êµ¬ì„±ìš”ì†Œ</option>
                                <option value="quality">í’ˆì§ˆ íŠ¹ì„±</option>
                                <option value="full">ì „ì²´ (ëª¨ë“  í•­ëª©)</option>
                                <option value="custom">ì‚¬ìš©ì ì •ì˜</option>
                            </select>
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">ë°ì´í„° ì…ë ¥ ë°©ì‹</label>
                            <select id="inputMethod">
                                <option value="manual">ìˆ˜ë™ ì…ë ¥</option>
                                <option value="excel">ì—‘ì…€ ì—…ë¡œë“œ</option>
                            </select>
                        </div>
                    </div>

                    <div id="customSurveyItems" style="display:none; margin-top: 20px;">
                        <label class="setting-label">ì¡°ì‚¬ í•­ëª© ì…ë ¥ (í•œ ì¤„ì— í•˜ë‚˜ì”©)</label>
                        <textarea id="customItems" placeholder="ì˜ˆ:&#10;ê°„ì¥(cm)&#10;ìˆ˜ì¥(cm)&#10;ìˆ˜ìˆ˜&#10;ì¶œìˆ˜ê¸°(ì›”.ì¼)&#10;ì²œë¦½ì¤‘(g)"></textarea>
                    </div>

                    <!-- ë‹¨ìœ„ ë³€í™˜ ì„¤ì • -->
                    <div id="conversionSection" class="conversion-section" style="display:none;">
                        <div class="panel-title" style="font-size: 15px; margin-bottom: 15px;">ğŸ“ ë‹¨ìœ„ ë³€í™˜ ì„¤ì •</div>
                        <div id="conversionItems"></div>
                    </div>
                </div>

                <!-- í’ˆì¢… ì…ë ¥ -->
                <div class="panel">
                    <div class="panel-title">ğŸŒ¾ ì¡°ì‚¬ í’ˆì¢…</div>
                    
                    <div class="form-group">
                        <label>í’ˆì¢… ëª©ë¡ (í•œ ì¤„ì— í•˜ë‚˜ì”©)</label>
                        <textarea id="surveyVarieties" placeholder="í•œì•„ë¦„&#10;ìƒˆì¼ë¯¸&#10;ì‚¼ê´‘"></textarea>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-info" onclick="loadFromListTab()">ğŸ“‹ í’ˆì¢…ëª©ë¡ì—ì„œ ê°€ì ¸ì˜¤ê¸°</button>
                        </div>
                    </div>

                    <div class="input-divider">ë˜ëŠ”</div>

                    <div class="form-group">
                        <label>ì—‘ì…€ í…œí”Œë¦¿ ì—…ë¡œë“œ</label>
                        <div class="file-upload">
                            <input type="file" id="surveyExcelFile" accept=".xlsx,.xls" onchange="handleSurveyExcelUpload(event)">
                            <label for="surveyExcelFile" class="file-upload-label">
                                ğŸ“‚ ì¡°ì‚¬ ë°ì´í„° ì—‘ì…€ ì—…ë¡œë“œ<br>
                                <small>í…œí”Œë¦¿ ì–‘ì‹ì˜ ì—‘ì…€ íŒŒì¼</small>
                            </label>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn btn-secondary" onclick="downloadSurveyTemplate()">ğŸ“¥ ì¡°ì‚¬ì–‘ì‹ í…œí”Œë¦¿</button>
                        <button class="btn btn-primary" onclick="generateTable()">ğŸ“Š ì¡°ì‚¬í‘œ ìƒì„±</button>
                        <button class="btn btn-warning" onclick="clearSurveyForm()">ğŸ”„ ì´ˆê¸°í™”</button>
                    </div>
                </div>

                <!-- ìƒì„±ëœ ì¡°ì‚¬í‘œ -->
                <div class="panel">
                    <div class="panel-title">ğŸ“Š ì¡°ì‚¬ ë°ì´í„° ì…ë ¥</div>
                    
                    <div class="output-section" id="surveyTableOutput">
                        <div class="output-empty">ì¡°ì‚¬ ì„¤ì •ì„ ì™„ë£Œí•˜ê³  'ì¡°ì‚¬í‘œ ìƒì„±' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                    </div>

                    <div class="actions" id="surveyActions" style="display:none;">
                        <button class="btn btn-success" onclick="calculateAllStats()">ğŸ“Š í†µê³„ ê³„ì‚°</button>
                        <button class="btn btn-secondary" onclick="saveSurveyData()">ğŸ’¾ ë°ì´í„° ì €ì¥</button>
                        <button class="btn btn-secondary" onclick="downloadSurveyExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn btn-secondary" onclick="downloadWithFormulas()">ğŸ“¥ ìˆ˜ì‹í¬í•¨ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            </div>

            <!-- ë°ì´í„° ë¶„ì„ íƒ­ -->
            <div id="analysisTab" class="tab-content">
                <div class="panel">
                    <div class="panel-title">ğŸ“ ë°ì´í„° ì—…ë¡œë“œ</div>
                    
                    <div class="form-group">
                        <label>ìƒìœ¡ì¡°ì‚¬ ë°ì´í„° íŒŒì¼ ì—…ë¡œë“œ</label>
                        <div class="alert alert-info">
                            <strong>ğŸ“Œ ì—…ë¡œë“œ ì•ˆë‚´:</strong><br>
                            â€¢ ìƒìœ¡ì¡°ì‚¬ íƒ­ì—ì„œ ìƒì„±í•œ ì–‘ì‹ì— ë°ì´í„° ì…ë ¥<br>
                            â€¢ ì²« ë²ˆì§¸ ì—´: í’ˆì¢…ëª… (ë°˜ë³µë³„ë¡œ ê° í–‰ì— ì…ë ¥)<br>
                            â€¢ ë‚˜ë¨¸ì§€ ì—´: ì¡°ì‚¬í•­ëª©ë³„ ì¸¡ì •ê°’<br>
                            â€¢ ê°™ì€ í’ˆì¢…ì˜ ë°˜ë³µê°„ í†µê³„ ë¶„ì„ ìˆ˜í–‰
                        </div>
                        <div class="file-upload">
                            <input type="file" id="dataFile" accept=".xlsx,.xls" onchange="handleDataUpload(event)">
                            <label for="dataFile" class="file-upload-label" id="dataFileLabel">
                                ğŸ“‚ í´ë¦­í•˜ì—¬ ë°ì´í„° íŒŒì¼ ì„ íƒ<br>
                                <small>ìƒìœ¡ì¡°ì‚¬ ë°ì´í„°ê°€ ì…ë ¥ëœ ì—‘ì…€ íŒŒì¼</small>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-title">ğŸ“Š ë¶„ì„ ì„¤ì •</div>
                    
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">ë¶„ì„í•  í•­ëª© ì„ íƒ</label>
                            <select id="analysisItem" onchange="updateAnalysis()">
                                <option value="">í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                        
                        <div class="setting-item">
                            <label class="setting-label">ìœ ì˜ìˆ˜ì¤€</label>
                            <select id="significanceLevel">
                                <option value="0.05" selected>0.05 (95%)</option>
                                <option value="0.01">0.01 (99%)</option>
                                <option value="0.001">0.001 (99.9%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-primary" onclick="runStatisticalAnalysis()">ğŸ“Š í†µê³„ ë¶„ì„ ì‹¤í–‰</button>
                        <button class="btn btn-secondary" onclick="exportAnalysisReport()">ğŸ“„ ë¶„ì„ ë³´ê³ ì„œ ë‚´ë³´ë‚´ê¸°</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">ğŸ“ˆ ê¸°ì´ˆ í†µê³„ëŸ‰</div>
                    
                    <div id="basicStatsTable" class="output-section">
                        <div class="output-empty">ë¶„ì„í•  í•­ëª©ì„ ì„ íƒí•˜ê³  'í†µê³„ ë¶„ì„ ì‹¤í–‰' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">ğŸ“Š ë¶„ì‚°ë¶„ì„ (ANOVA)</div>
                    
                    <div id="anovaResults" class="output-section">
                        <div class="output-empty">ANOVA ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">ğŸ“Š Duncan's Multiple Range Test (DMRT)</div>
                    
                    <div id="dmrtResults" class="output-section">
                        <div class="output-empty">DMRT ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">ğŸ“ˆ ë°ì´í„° ì‹œê°í™”</div>
                    
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">ì°¨íŠ¸ ìœ í˜•</label>
                            <select id="chartType" onchange="updateChart()">
                                <option value="bar">ë§‰ëŒ€ ê·¸ë˜í”„</option>
                                <option value="line">ì„  ê·¸ë˜í”„</option>
                                <option value="box">ë°•ìŠ¤í”Œë¡¯</option>
                                <option value="scatter">ì‚°ì ë„</option>
                            </select>
                        </div>
                        
                        <div class="setting-item">
                            <label class="setting-label">ì˜¤ì°¨ ë§‰ëŒ€</label>
                            <select id="errorBar" onchange="updateChart()">
                                <option value="none">ì—†ìŒ</option>
                                <option value="se">í‘œì¤€ì˜¤ì°¨ (SE)</option>
                                <option value="sd">í‘œì¤€í¸ì°¨ (SD)</option>
                                <option value="ci95">95% ì‹ ë¢°êµ¬ê°„</option>
                            </select>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="analysisChart"></canvas>
                    </div>

                    <div class="actions">
                        <button class="btn btn-secondary" onclick="downloadChart()">ğŸ“¥ ì°¨íŠ¸ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            </div>

            <!-- ë¼ë²¨ ì¶œë ¥ íƒ­ -->
            <div id="labelTab" class="tab-content">
                <div class="panel">
                    <div class="panel-title">ğŸ·ï¸ ë¼ë²¨ ìœ í˜• ì„ íƒ</div>
                    
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">ë¼ë²¨ ìš©ë„</label>
                            <select id="labelType" onchange="updateLabelType()">
                                <option value="display">ì „ì‹œìš© ë¼ë²¨ (ë°°ê²½ì´ë¯¸ì§€)</option>
                                <option value="barcode">ë°”ì½”ë“œ/QR ë¼ë²¨</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ì „ì‹œìš© ë¼ë²¨ ì„¤ì • -->
                <div id="displayLabelSettings" class="panel">
                    <div class="panel-title">ğŸ–¼ï¸ ì „ì‹œìš© ë¼ë²¨ ì„¤ì •</div>
                    
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">ë¼ë²¨ í¬ê¸°</label>
                            <select id="displayLabelSize" onchange="updateDisplaySizeInfo()">
                                <option value="small">ì†Œí˜• (75mm Ã— 40mm)</option>
                                <option value="medium" selected>ì¤‘í˜• (75mm Ã— 50mm)</option>
                                <option value="large">ëª…ì°°ìš© (150mm Ã— 75mm)</option>
                            </select>
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">ë¼ë²¨ ë ˆì´ì•„ì›ƒ</label>
                            <select id="displayLabelLayout" onchange="updateLabelPreview()">
                                <option value="1x1">ë‹¨ì¼ ë¼ë²¨</option>
                                <option value="2x4">2 x 4 (A4)</option>
                                <option value="2x5">2 x 5 (A4)</option>
                            </select>
                        </div>
                    </div>

                    <div id="sizeRecommendation" class="alert alert-info" style="margin-top: 15px;">
                        <strong>ğŸ“ ë¼ë²¨ ê·œê²©</strong><br>
                        <span id="recommendedSize">ì¤‘í˜•: 75mm Ã— 50mm</span>
                    </div>

                    <div class="form-group">
                        <label>ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
                        <div class="file-upload">
                            <input type="file" id="bgImageFile" accept="image/*" onchange="handleBgImageUpload(event)">
                            <label for="bgImageFile" class="file-upload-label">
                                ğŸ–¼ï¸ í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ<br>
                                <small>JPG, PNG í˜•ì‹ ì§€ì›</small>
                            </label>
                        </div>
                    </div>

                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">ì´ë¯¸ì§€ ì¡°ì •</label>
                            <select id="imageFit" onchange="updateLabelPreview()">
                                <option value="cover">ì±„ìš°ê¸° (ë¹„ìœ¨ ìœ ì§€)</option>
                                <option value="contain">ë§ì¶”ê¸° (ì „ì²´ ë³´ì´ê¸°)</option>
                                <option value="stretch">ëŠ˜ë¦¬ê¸° (ë¹„ìœ¨ ë¬´ì‹œ)</option>
                                <option value="center">ì¤‘ì•™ ì •ë ¬</option>
                            </select>
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">í…ìŠ¤íŠ¸ ìƒ‰ìƒ</label>
                            <input type="color" id="textColor" value="#000000" onchange="updateLabelPreview()">
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">í…ìŠ¤íŠ¸ ë°°ê²½</label>
                            <select id="textBg" onchange="updateLabelPreview()">
                                <option value="none">ì—†ìŒ</option>
                                <option value="white">í°ìƒ‰ ë°˜íˆ¬ëª…</option>
                                <option value="black">ê²€ì • ë°˜íˆ¬ëª…</option>
                                <option value="blur">ë¸”ëŸ¬ íš¨ê³¼</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">ì´ë¦„ (í•„ìˆ˜)</label>
                            <textarea id="displayNames" rows="5" placeholder="í•œì•„ë¦„
ìƒˆì¼ë¯¸
ì‚¼ê´‘"></textarea>
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">ë¶€ê°€ì„¤ëª… (ì†Œí˜•/ì¤‘í˜•) ë˜ëŠ” ì†Œì† (ëª…ì°°ìš©)</label>
                            <input type="text" id="displayInfo1" placeholder="ì˜ˆ: 2024ë…„ ì‹œí—˜ ë˜ëŠ” ë†ì´Œì§„í¥ì²­">
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn btn-primary" onclick="generateDisplayLabels()">ğŸ·ï¸ ì „ì‹œìš© ë¼ë²¨ ìƒì„±</button>
                        <button class="btn btn-warning" onclick="resetBgImage()">ğŸ”„ ì´ë¯¸ì§€ ì´ˆê¸°í™”</button>
                    </div>
                </div>

                <!-- ë°”ì½”ë“œ/QR ë¼ë²¨ ì„¤ì • -->
                <div id="barcodeLabelSettings" class="panel" style="display:none;">
                    <div class="panel-title">ğŸ“Š QRì½”ë“œ ë¼ë²¨ ì„¤ì •</div>
                    
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">ë¼ë²¨ ê·œê²©</label>
                            <select id="labelSpec" onchange="updateLabelSpec()">
                                <option value="3106">í¼í… 3106 (64mm Ã— 34mm, 24ì¹¸)</option>
                                <option value="3105">í¼í… 3105 (64mm Ã— 39mm, 21ì¹¸)</option>
                            </select>
                        </div>
                    </div>

                    <div id="labelSpecInfo" class="alert alert-info">
                        <strong>ğŸ“‹ í¼í… 3106 ë¼ë²¨ ê·œê²©</strong><br>
                        â€¢ ë¼ë²¨ í¬ê¸°: 64mm Ã— 34mm<br>
                        â€¢ ë°°ì—´: 3ì—´ Ã— 8í–‰ (A4 í•œ ì¥ì— 24ê°œ)<br>
                        â€¢ ì—¬ë°±: ìœ„/ì•„ë˜ 12mm, ì¢Œ/ìš° 5mm, ì—´ ê°„ê²© 2mm
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <div class="panel-title" style="font-size: 16px;">ğŸ”¢ ì‹œë£Œë²ˆí˜¸ ìë™ ìƒì„±</div>
                        
                        <div class="settings-grid">
                            <div class="setting-item">
                                <label class="setting-label">ì—°ë„ (4ìë¦¬)</label>
                                <input type="number" id="sampleYear" placeholder="ì˜ˆ: 2024" min="2000" max="2099" 
                                       value="2024" onchange="updateSampleNumberFormat()">
                            </div>

                            <div class="setting-item">
                                <label class="setting-label">ì‹¤í—˜ì‹¤</label>
                                <select id="labCode" onchange="updateSampleNumberFormat()">
                                    <option value="1">ê°€ê³µì‹¤ (1)</option>
                                    <option value="2">ì´ëª¨ì‘ì‹¤ (2)</option>
                                    <option value="3">ê²½ì§€ì‹¤ (3)</option>
                                </select>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label">ì‹œí—˜ë²ˆí˜¸</label>
                                <input type="text" id="testNumberInput" placeholder="ì˜ˆ: 001 ë˜ëŠ” 000001" 
                                       maxlength="6" onchange="updateSampleNumberFormat()">
                            </div>
                        </div>

                        <div id="sampleNumberPreview" class="alert alert-success" style="margin-top: 15px;">
                            <strong>ì‹œë£Œë²ˆí˜¸ ìƒì„± ê·œì¹™:</strong><br>
                            <span id="sampleFormatExample">2024 0 1 000001</span><br>
                            <small>ì—°ë„(4) + 0(1) + ì‹¤í—˜ì‹¤(1) + ì‹œí—˜ë²ˆí˜¸(6, ì•ì— 0 ì¶”ê°€) = ì´ 12ìë¦¬</small>
                        </div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <div class="panel-title" style="font-size: 16px;">ğŸ“¥ ë¼ë²¨ ë°ì´í„° ì…ë ¥</div>
                        
                        <div class="form-group">
                            <label>ì—‘ì…€ í…œí”Œë¦¿ ì—…ë¡œë“œ</label>
                            <div class="file-upload">
                                <input type="file" id="qrLabelFile" accept=".xlsx,.xls" onchange="handleQRLabelUpload(event)">
                                <label for="qrLabelFile" class="file-upload-label">
                                    ğŸ“‚ QRë¼ë²¨ ë°ì´í„° ì—‘ì…€ ì—…ë¡œë“œ<br>
                                    <small>í’ˆì¢… ë° ê³„í†µ ëª©ë¡ì´ í¬í•¨ëœ íŒŒì¼</small>
                                </label>
                            </div>
                        </div>

                        <div class="input-divider">ë˜ëŠ”</div>

                        <div class="form-group">
                            <label>í’ˆì¢… ì§ì ‘ ì…ë ¥</label>
                            <button class="btn btn-info" onclick="showQRDataInput()">ğŸ“ í’ˆì¢… ì§ì ‘ ì…ë ¥</button>
                        </div>

                        <div id="qrDataInput" style="display:none; margin-top: 20px;">
                            <div class="alert alert-warning">
                                <strong>ì…ë ¥ í˜•ì‹:</strong> í’ˆì¢…ëª…ì„ í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥<br>
                                <small>ì‹œë£Œë²ˆí˜¸ëŠ” ìœ„ì—ì„œ ì„¤ì •í•œ í˜•ì‹ìœ¼ë¡œ ìë™ ìƒì„±ë©ë‹ˆë‹¤</small>
                            </div>
                            <textarea id="qrDataText" rows="10" placeholder="í•œì•„ë¦„
ìƒˆì¼ë¯¸
ì‚¼ê´‘
ì°¸ë™ì§„
ì‹ ë™ì§„"></textarea>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn btn-secondary" onclick="downloadQRTemplate()">ğŸ“¥ QRë¼ë²¨ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn btn-primary" onclick="generateQRLabels()">ğŸ·ï¸ QRë¼ë²¨ ìƒì„±</button>
                        <button class="btn btn-warning" onclick="clearQRData()">ğŸ”„ ì´ˆê¸°í™”</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">ğŸ‘ï¸ ë¼ë²¨ ë¯¸ë¦¬ë³´ê¸°</div>
                    
                    <div id="labelPreview" class="output-section">
                        <div class="output-empty">ë¼ë²¨ ì„¤ì •ì„ ì™„ë£Œí•˜ê³  'ë¼ë²¨ ìƒì„±' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                    </div>

                    <div class="actions" id="labelActions" style="display:none;">
                        <button class="btn btn-success" onclick="printLabels()">ğŸ–¨ï¸ ì¸ì‡„</button>
                        <button class="btn btn-secondary" onclick="downloadLabelsPDF()">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn btn-secondary" onclick="downloadLabelsExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let varieties = [];
        let tableData = [];
        let conversionSettings = {};
        let analysisData = {};
        let currentChart = null;
        let surveyItems = [];
        let excelData = null;
        let bgImageData = null;
        let qrLabelData = [];
        let surveyData = {};

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            for (let i = 0; i < 3; i++) addInputRow();
            updateSurveyItems();
        });

        // íƒ­ ì „í™˜
        function switchTab(event, tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        // ========== í’ˆì¢… ëª©ë¡ ìƒì„± ê¸°ëŠ¥ ==========
        
        function addInputRow() {
            const container = document.getElementById('varietyInputs');
            const row = document.createElement('div');
            row.className = 'input-row';
            row.innerHTML = `
                <input type="text" placeholder="í’ˆì¢…ëª… ì…ë ¥">
                <input type="number" placeholder="ë°˜ë³µìˆ˜" min="1" max="20">
                <button class="btn-remove" onclick="removeInputRow(this)">ì‚­ì œ</button>
            `;
            container.appendChild(row);
        }

        function removeInputRow(btn) {
            btn.parentElement.remove();
        }

        function generateList() {
            varieties = [];
            const rows = document.querySelectorAll('#varietyInputs .input-row');
            rows.forEach(row => {
                const name = row.querySelector('input[type="text"]').value.trim();
                const repeat = parseInt(row.querySelector('input[type="number"]').value) || 0;
                if (name && repeat > 0) {
                    for (let i = 1; i <= repeat; i++) {
                        varieties.push({ name, repeat: i, full: `${name}-${i}` });
                    }
                }
            });
            const bulkInput = document.getElementById('bulkInput').value.trim();
            if (bulkInput) {
                const defaultRepeat = parseInt(document.getElementById('defaultRepeatCount').value) || 3;
                bulkInput.split('\n').map(v => v.trim()).filter(v => v).forEach(variety => {
                    for (let i = 1; i <= defaultRepeat; i++) {
                        varieties.push({ name: variety, repeat: i, full: `${variety}-${i}` });
                    }
                });
            }
            if (excelData && excelData.length > 0) {
                excelData.forEach(row => {
                    const variety = row['í’ˆì¢…ëª…'] || row['Variety'] || row['variety'] || row['í’ˆì¢…'];
                    const repeat = parseInt(row['ë°˜ë³µìˆ˜'] || row['Repeat'] || row['repeat']) || 3;
                    if (variety) {
                        for (let i = 1; i <= repeat; i++) {
                            varieties.push({ name: variety, repeat: i, full: `${variety}-${i}` });
                        }
                    }
                });
            }
            if (varieties.length === 0) {
                alert('í’ˆì¢…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            updateVarietyList();
            alert(`${varieties.length}ê°œì˜ í’ˆì¢… ëª©ë¡ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        function updateVarietyList() {
            const output = document.getElementById('listOutput');
            if (varieties.length === 0) {
                output.innerHTML = '<div class="output-empty">í’ˆì¢…ì„ ì…ë ¥í•˜ê±°ë‚˜ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•œ í›„<br>\'ëª©ë¡ ìƒì„±\' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>';
                return;
            }
            let html = '<div class="variety-list">';
            varieties.forEach(v => html += `<div class="variety-item">${v.full}</div>`);
            html += '</div>';
            output.innerHTML = html;
        }

        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const label = document.getElementById('excelLabel');
            const fileSize = (file.size / 1024).toFixed(1);
            label.innerHTML = `<div style="color: #1976d2; font-weight: bold;">ğŸ“„ ${file.name}</div><small style="color: #666;">${fileSize} KB ì—…ë¡œë“œë¨</small>`;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    excelData = XLSX.utils.sheet_to_json(sheet);
                    alert('ì—‘ì…€ íŒŒì¼ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. "í’ˆì¢… ëª©ë¡ ìƒì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
                } catch (error) {
                    alert('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ' + error.message);
                    excelData = null;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadListTemplate() {
            const wb = XLSX.utils.book_new();
            const data = [
                ['í’ˆì¢…ëª…', 'ë°˜ë³µìˆ˜', '', 'ğŸ“Œ ì…ë ¥ ë°©ë²•'],
                ['í•œì•„ë¦„', '3', '', 'â€¢ í’ˆì¢…ëª…: ì¡°ì‚¬í•  í’ˆì¢… ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'],
                ['ìƒˆì¼ë¯¸', '3', '', 'â€¢ ë°˜ë³µìˆ˜: ê° í’ˆì¢…ì„ ëª‡ ë²ˆ ë°˜ë³µí• ì§€ ìˆ«ì ì…ë ¥'],
                ['ì‚¼ê´‘', '5', '', ''],
                ['ì°¸ë™ì§„', '3', '', 'ğŸ’¡ ì˜ˆì‹œ'],
                ['ì‹ ë™ì§„', '4', '', 'í’ˆì¢…ëª…: í•œì•„ë¦„ / ë°˜ë³µìˆ˜: 3'],
                ['', '', '', '  â†’ ê²°ê³¼: í•œì•„ë¦„-1, í•œì•„ë¦„-2, í•œì•„ë¦„-3']
            ];
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 18 }, { wch: 12 }, { wch: 2 }, { wch: 45 }];
            XLSX.utils.book_append_sheet(wb, ws, 'í’ˆì¢…ëª©ë¡');
            XLSX.writeFile(wb, 'í’ˆì¢…ëª©ë¡_í…œí”Œë¦¿.xlsx');
        }

        function copyListToClipboard() {
            if (varieties.length === 0) {
                alert('ë³µì‚¬í•  í’ˆì¢… ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const text = varieties.map(v => v.full).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                alert('í’ˆì¢… ëª©ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            });
        }

        function downloadListExcel() {
            if (varieties.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  í’ˆì¢… ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const wb = XLSX.utils.book_new();
            const data = [['ë²ˆí˜¸', 'í’ˆì¢…ëª…', 'ë°˜ë³µ', 'ì „ì²´ëª…']];
            varieties.forEach((v, i) => {
                data.push([i + 1, v.name, v.repeat, v.full]);
            });
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'í’ˆì¢…ëª©ë¡');
            XLSX.writeFile(wb, 'í’ˆì¢…ëª©ë¡_' + getDateString() + '.xlsx');
        }

        function downloadListCSV() {
            if (varieties.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  í’ˆì¢… ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            let csv = 'ë²ˆí˜¸,í’ˆì¢…ëª…,ë°˜ë³µ,ì „ì²´ëª…\n';
            varieties.forEach((v, i) => {
                csv += `${i + 1},${v.name},${v.repeat},${v.full}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'í’ˆì¢…ëª©ë¡_' + getDateString() + '.csv';
            a.click();
        }

        function clearInputs() {
            document.getElementById('bulkInput').value = '';
            document.getElementById('varietyInputs').innerHTML = '';
            for (let i = 0; i < 3; i++) addInputRow();
            excelData = null;
            document.getElementById('excelFile').value = '';
            document.getElementById('excelLabel').innerHTML = 'ğŸ“‚ í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ<br><small>ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸</small>';
        }

        function clearListOutput() {
            varieties = [];
            updateVarietyList();
        }

        // ========== ìƒìœ¡ì¡°ì‚¬ ì–‘ì‹ ê¸°ëŠ¥ ==========
        
        function updateSurveyItems() {
            const surveyType = document.getElementById('surveyType').value;
            const customItems = document.getElementById('customSurveyItems');
            const conversionSection = document.getElementById('conversionSection');
            if (surveyType === 'custom') {
                customItems.style.display = 'block';
                conversionSection.style.display = 'none';
            } else {
                customItems.style.display = 'none';
                conversionSection.style.display = 'block';
                setupConversionItems(surveyType);
            }
        }

        function setupConversionItems(surveyType) {
            const items = getSurveyItems(surveyType);
            const container = document.getElementById('conversionItems');
            let html = '';
            items.forEach((item, index) => {
                html += `
                    <div class="conversion-item">
                        <label>
                            <input type="checkbox" id="conv_${index}" onchange="updateConversion(${index})">
                            ${item}
                        </label>
                        <input type="number" id="mult_${index}" placeholder="ë°°ìˆ˜" step="0.1" min="0" 
                               onchange="updateConversion(${index})" disabled>
                        <select id="formula_${index}" onchange="updateConversion(${index})" disabled>
                            <option value="divide">ë‚˜ëˆ„ê¸° (Ã·)</option>
                            <option value="multiply">ê³±í•˜ê¸° (Ã—)</option>
                        </select>
                        <span class="formula-display" id="formula_display_${index}"></span>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function updateConversion(index) {
            const checkbox = document.getElementById(`conv_${index}`);
            const multiplier = document.getElementById(`mult_${index}`);
            const formula = document.getElementById(`formula_${index}`);
            const display = document.getElementById(`formula_display_${index}`);
            multiplier.disabled = !checkbox.checked;
            formula.disabled = !checkbox.checked;
            if (checkbox.checked) {
                const multValue = parseFloat(multiplier.value) || 1;
                const operation = formula.value;
                conversionSettings[index] = {
                    enabled: true,
                    multiplier: multValue,
                    operation: operation
                };
                const symbol = operation === 'multiply' ? 'Ã—' : 'Ã·';
                display.textContent = `ì›ë˜ê°’ = ì…ë ¥ê°’ ${symbol} ${multValue}`;
                const table = document.getElementById('dataTable');
                if (table) generateTable();
            } else {
                delete conversionSettings[index];
                display.textContent = '';
                const table = document.getElementById('dataTable');
                if (table) generateTable();
            }
        }

        function getSurveyItems(type) {
            switch(type) {
                case 'basic':
                    return ['ê°„ì¥(cm)', 'ìˆ˜ì¥(cm)', 'ìˆ˜ìˆ˜'];
                case 'heading':
                    return ['ê°„ì¥(cm)', 'ìˆ˜ì¥(cm)', 'ìˆ˜ìˆ˜', 'ì¶œìˆ˜ê¸°(ì›”.ì¼)'];
                case 'yield':
                    return ['ìˆ˜ìˆ˜', '1ìˆ˜ì˜í™”ìˆ˜', 'ë“±ìˆ™ë¥ (%)', 'ì²œë¦½ì¤‘(g)', 'ìˆ˜ëŸ‰(kg/10a)'];
                case 'quality':
                    return ['í˜„ë¯¸ì¥(mm)', 'í˜„ë¯¸í­(mm)', 'ì¥í­ë¹„', 'ë‹¨ë°±ì§ˆ(%)', 'ì•„ë°€ë¡œìŠ¤(%)'];
                case 'full':
                    return ['ê°„ì¥(cm)', 'ìˆ˜ì¥(cm)', 'ìˆ˜ìˆ˜', 'ì¶œìˆ˜ê¸°(ì›”.ì¼)', '1ìˆ˜ì˜í™”ìˆ˜', 
                           'ë“±ìˆ™ë¥ (%)', 'ì²œë¦½ì¤‘(g)', 'ìˆ˜ëŸ‰(kg/10a)', 'í˜„ë¯¸ì¥(mm)', 
                           'í˜„ë¯¸í­(mm)', 'ì¥í­ë¹„', 'ë‹¨ë°±ì§ˆ(%)', 'ì•„ë°€ë¡œìŠ¤(%)'];
                case 'custom':
                    const customText = document.getElementById('customItems').value;
                    return customText.split('\n').map(item => item.trim()).filter(item => item);
                default:
                    return ['ê°„ì¥(cm)', 'ìˆ˜ì¥(cm)', 'ìˆ˜ìˆ˜'];
            }
        }

        function loadFromListTab() {
            if (!varieties || varieties.length === 0) {
                alert('ë¨¼ì € í’ˆì¢…ëª©ë¡ íƒ­ì—ì„œ í’ˆì¢…ì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }
            const uniqueVarieties = [];
            const seen = new Set();
            varieties.forEach(v => {
                const varietyName = v.name || v.full?.split('-')[0] || v;
                if (varietyName && !seen.has(varietyName)) {
                    seen.add(varietyName);
                    uniqueVarieties.push(varietyName);
                }
            });
            if (uniqueVarieties.length > 0) {
                document.getElementById('surveyVarieties').value = uniqueVarieties.join('\n');
                alert('í’ˆì¢…ëª©ë¡ì—ì„œ í’ˆì¢…ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.');
            } else {
                alert('ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” í’ˆì¢…ì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        function generateTable() {
            const varietiesText = document.getElementById('surveyVarieties').value.trim();
            const repeatCount = parseInt(document.getElementById('repeatCount').value);
            const surveyType = document.getElementById('surveyType').value;
            if (!varietiesText) {
                alert('ì¡°ì‚¬í•  í’ˆì¢…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!repeatCount || repeatCount < 1) {
                alert('ë°˜ë³µ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            const varietyList = varietiesText.split('\n').map(v => v.trim()).filter(v => v);
            surveyItems = getSurveyItems(surveyType);
            if (surveyItems.length === 0) {
                alert('ì¡°ì‚¬ í•­ëª©ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }
            const hasConversion = Object.keys(conversionSettings).length > 0;
            let html = '<table id="dataTable">';
            html += '<thead><tr>';
            html += '<th>í’ˆì¢…</th>';
            html += '<th>ë°˜ë³µ</th>';
            surveyItems.forEach((item, idx) => {
                html += `<th>${item}</th>`;
                if (conversionSettings[idx] && conversionSettings[idx].enabled) {
                    const mult = conversionSettings[idx].multiplier;
                    const op = conversionSettings[idx].operation === 'multiply' ? 'Ã—' : 'Ã·';
                    html += `<th style="background-color: #e8f4ff;">${item}<br>(í™˜ì‚° ${op}${mult})</th>`;
                }
            });
            html += '</tr></thead><tbody>';
            varietyList.forEach((variety, vIdx) => {
                for (let r = 1; r <= repeatCount; r++) {
                    const isLastRepeat = r === repeatCount;
                    const isLastVariety = vIdx === varietyList.length - 1;
                    const borderClass = !isLastVariety && isLastRepeat ? 'thick-bottom-border' : '';
                    html += `<tr class="${borderClass}">`;
                    html += `<td style="font-weight: bold;">${variety}</td>`;
                    html += `<td style="text-align: center;">${r}</td>`;
                    surveyItems.forEach((item, iIdx) => {
                        const cellId = `cell_${vIdx}_${iIdx}_${r-1}`;
                        html += `<td><input type="number" id="${cellId}" step="0.01" 
                                onchange="updateDataWithConversion(${vIdx}, ${iIdx}, ${r-1})"></td>`;
                        if (conversionSettings[iIdx] && conversionSettings[iIdx].enabled) {
                            html += `<td class="converted-value" id="conv_${vIdx}_${iIdx}_${r-1}" style="background-color: #f5fbff; font-weight: bold; color: #0066cc;">-</td>`;
                        }
                    });
                    html += '</tr>';
                }
            });
            html += '</tbody></table>';
            if (hasConversion) {
                html += '<div class="alert alert-info" style="margin-top: 20px;">';
                html += '<strong>ğŸ“Š ë‹¨ìœ„ ë³€í™˜ ì ìš© ì¤‘</strong><br>';
                surveyItems.forEach((item, idx) => {
                    if (conversionSettings[idx] && conversionSettings[idx].enabled) {
                        const mult = conversionSettings[idx].multiplier;
                        const op = conversionSettings[idx].operation;
                        const symbol = op === 'multiply' ? 'Ã—' : 'Ã·';
                        html += `â€¢ ${item}: ì…ë ¥ê°’ ${symbol} ${mult} = í™˜ì‚°ê°’<br>`;
                    }
                });
                html += '<small>í™˜ì‚°ê°’ì€ ìë™ìœ¼ë¡œ ê³„ì‚°ë˜ë©° íŒŒë€ìƒ‰ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</small>';
                html += '</div>';
            }
            document.getElementById('surveyTableOutput').innerHTML = html;
            document.getElementById('surveyActions').style.display = 'flex';
            tableData = varietyList.map(() => 
                surveyItems.map(() => new Array(repeatCount).fill(null))
            );
            window.surveyVarietyList = varietyList;
            window.surveyRepeatCount = repeatCount;
        }

        function updateDataWithConversion(varietyIdx, itemIdx, repeatIdx) {
            const cellId = `cell_${varietyIdx}_${itemIdx}_${repeatIdx}`;
            const input = document.getElementById(cellId);
            if (input && input.value) {
                const value = parseFloat(input.value);
                if (!isNaN(value)) {
                    tableData[varietyIdx][itemIdx][repeatIdx] = value;
                    if (conversionSettings[itemIdx] && conversionSettings[itemIdx].enabled) {
                        const mult = conversionSettings[itemIdx].multiplier;
                        const op = conversionSettings[itemIdx].operation;
                        let convertedValue;
                        if (op === 'multiply') {
                            convertedValue = value * mult;
                        } else {
                            convertedValue = value / mult;
                        }
                        const convCell = document.getElementById(`conv_${varietyIdx}_${itemIdx}_${repeatIdx}`);
                        if (convCell) {
                            convCell.textContent = convertedValue.toFixed(2);
                        }
                    }
                }
            } else {
                tableData[varietyIdx][itemIdx][repeatIdx] = null;
                const convCell = document.getElementById(`conv_${varietyIdx}_${itemIdx}_${repeatIdx}`);
                if (convCell) {
                    convCell.textContent = '-';
                }
            }
        }

        function calculateAllStats() {
            document.querySelector('.nav-tab:nth-child(3)').click();
            const select = document.getElementById('analysisItem');
            select.innerHTML = '<option value="">í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            if (surveyItems && surveyItems.length > 0) {
                surveyItems.forEach((item, idx) => {
                    const option = document.createElement('option');
                    option.value = idx;
                    option.textContent = item;
                    select.appendChild(option);
                });
                if (surveyItems.length > 0) {
                    select.value = 0;
                }
            }
            alert('ë°ì´í„° ë¶„ì„ íƒ­ì—ì„œ í†µê³„ ë¶„ì„ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        function saveSurveyData() {
            const dataStr = JSON.stringify(tableData);
            localStorage.setItem('surveyData', dataStr);
            localStorage.setItem('surveyItems', JSON.stringify(surveyItems));
            alert('ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function downloadSurveyTemplate() {
            const wb = XLSX.utils.book_new();
            const repeatCount = parseInt(document.getElementById('repeatCount').value) || 3;
            const surveyType = document.getElementById('surveyType').value;
            const items = getSurveyItems(surveyType);
            const headers = ['í’ˆì¢…', 'ë°˜ë³µ'];
            items.forEach(item => {
                headers.push(item);
            });
            const data = [
                headers,
                ['í•œì•„ë¦„', '1', ...new Array(items.length).fill('')],
                ['í•œì•„ë¦„', '2', ...new Array(items.length).fill('')],
                ['í•œì•„ë¦„', '3', ...new Array(items.length).fill('')],
                ['ìƒˆì¼ë¯¸', '1', ...new Array(items.length).fill('')],
                ['ìƒˆì¼ë¯¸', '2', ...new Array(items.length).fill('')],
                ['ìƒˆì¼ë¯¸', '3', ...new Array(items.length).fill('')]
            ];
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'ìƒìœ¡ì¡°ì‚¬');
            XLSX.writeFile(wb, 'ìƒìœ¡ì¡°ì‚¬_í…œí”Œë¦¿.xlsx');
        }

        function downloadSurveyExcel() {
            const table = document.getElementById('dataTable');
            if (!table) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, 'ìƒìœ¡ì¡°ì‚¬');
            XLSX.writeFile(wb, 'ìƒìœ¡ì¡°ì‚¬_' + getDateString() + '.xlsx');
        }

        function downloadWithFormulas() {
            downloadSurveyExcel();
        }

        function handleSurveyExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    alert('ì¡°ì‚¬ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    alert('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function clearSurveyForm() {
            document.getElementById('surveyVarieties').value = '';
            document.getElementById('surveyTableOutput').innerHTML = '<div class="output-empty">ì¡°ì‚¬ ì„¤ì •ì„ ì™„ë£Œí•˜ê³  \'ì¡°ì‚¬í‘œ ìƒì„±\' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>';
            document.getElementById('surveyActions').style.display = 'none';
            tableData = [];
            surveyItems = [];
        }

        // ========== ë°ì´í„° ë¶„ì„ ê¸°ëŠ¥ ==========
        
        function handleDataUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const label = document.getElementById('dataFileLabel');
            const fileSize = (file.size / 1024).toFixed(1);
            label.innerHTML = `<div style="color: #1976d2; font-weight: bold;">ğŸ“„ ${file.name}</div><small style="color: #666;">${fileSize} KB ì—…ë¡œë“œë¨</small>`;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    surveyData = {};
                    const headers = Object.keys(jsonData[0] || {});
                    const varietyCol = headers[0];
                    jsonData.forEach(row => {
                        const variety = row[varietyCol];
                        if (!variety || variety === 'í‰ê· ' || variety === 'Average') return;
                        if (!surveyData[variety]) {
                            surveyData[variety] = {};
                        }
                        headers.forEach(header => {
                            if (header === varietyCol) return;
                            if (!surveyData[variety][header]) {
                                surveyData[variety][header] = [];
                            }
                            const value = parseFloat(row[header]);
                            if (!isNaN(value)) {
                                surveyData[variety][header].push(value);
                            }
                        });
                    });
                    const items = new Set();
                    Object.values(surveyData).forEach(varietyData => {
                        Object.keys(varietyData).forEach(item => items.add(item));
                    });
                    const itemSelect = document.getElementById('analysisItem');
                    itemSelect.innerHTML = '<option value="">í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                    items.forEach(item => {
                        itemSelect.innerHTML += `<option value="${item}">${item}</option>`;
                    });
                    let varietyInfo = [];
                    Object.keys(surveyData).forEach(variety => {
                        const firstItem = Object.keys(surveyData[variety])[0];
                        const repeatCount = surveyData[variety][firstItem]?.length || 0;
                        if (repeatCount > 0) {
                            varietyInfo.push(`${variety}(${repeatCount}ë°˜ë³µ)`);
                        }
                    });
                    alert(`âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${varietyInfo.join(', ')}`);
                    if (items.size > 0) {
                        itemSelect.selectedIndex = 1;
                        updateAnalysis();
                    }
                } catch (error) {
                    alert('ë°ì´í„° íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ' + error.message);
                    label.innerHTML = `ğŸ“‚ í´ë¦­í•˜ì—¬ ë°ì´í„° íŒŒì¼ ì„ íƒ<br><small>ìƒìœ¡ì¡°ì‚¬ ë°ì´í„°ê°€ ì…ë ¥ëœ ì—‘ì…€ íŒŒì¼</small>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function runStatisticalAnalysis() {
            const item = document.getElementById('analysisItem').value;
            if (!item || !surveyData || Object.keys(surveyData).length === 0) {
                alert('ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ê³  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”');
                return;
            }
            const varietyData = {};
            Object.keys(surveyData).forEach(variety => {
                varietyData[variety] = surveyData[variety][item] || [];
            });
            displayBasicStats(varietyData, item);
            performANOVA(varietyData, item);
            performDMRT(varietyData, item);
            updateChart();
        }

        function calculateStatistics(values) {
            const n = values.length;
            const mean = values.reduce((a, b) => a + b, 0) / n;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (n - 1);
            const std = Math.sqrt(variance);
            const se = std / Math.sqrt(n);
            const cv = (std / mean) * 100;
            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = max - min;
            return { n, mean, std, se, variance, cv, min, max, range, values };
        }

        function displayBasicStats(varietyData, itemName) {
            let html = '<h4>' + itemName + ' ê¸°ì´ˆ í†µê³„ëŸ‰</h4>';
            html += '<table>';
            html += '<thead><tr>';
            html += '<th>í’ˆì¢…</th><th>n</th><th>í‰ê· </th><th>í‘œì¤€í¸ì°¨</th><th>í‘œì¤€ì˜¤ì°¨</th>';
            html += '<th>CV(%)</th><th>ìµœì†Œê°’</th><th>ìµœëŒ€ê°’</th>';
            html += '</tr></thead><tbody>';
            Object.keys(varietyData).forEach(variety => {
                const values = varietyData[variety];
                if (values.length > 0) {
                    const stats = calculateStatistics(values);
                    html += '<tr>';
                    html += `<td><strong>${variety}</strong></td>`;
                    html += `<td>${stats.n}</td>`;
                    html += `<td>${stats.mean.toFixed(2)}</td>`;
                    html += `<td>${stats.std.toFixed(2)}</td>`;
                    html += `<td>${stats.se.toFixed(2)}</td>`;
                    html += `<td>${stats.cv.toFixed(1)}</td>`;
                    html += `<td>${stats.min.toFixed(2)}</td>`;
                    html += `<td>${stats.max.toFixed(2)}</td>`;
                    html += '</tr>';
                }
            });
            html += '</tbody></table>';
            document.getElementById('basicStatsTable').innerHTML = html;
        }

        function performANOVA(varietyData, itemName) {
            const groups = Object.keys(varietyData);
            const k = groups.length;
            if (k < 2) {
                document.getElementById('anovaResults').innerHTML = 
                    '<div class="alert alert-warning">ANOVAë¥¼ ìˆ˜í–‰í•˜ë ¤ë©´ ìµœì†Œ 2ê°œ ì´ìƒì˜ í’ˆì¢…ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
                return;
            }
            let grandTotal = 0;
            let totalN = 0;
            groups.forEach(variety => {
                varietyData[variety].forEach(value => {
                    grandTotal += value;
                    totalN++;
                });
            });
            const grandMean = grandTotal / totalN;
            let SST = 0;
            groups.forEach(variety => {
                varietyData[variety].forEach(value => {
                    SST += Math.pow(value - grandMean, 2);
                });
            });
            let SSB = 0;
            groups.forEach(variety => {
                const values = varietyData[variety];
                if (values.length > 0) {
                    const groupMean = values.reduce((a, b) => a + b, 0) / values.length;
                    SSB += values.length * Math.pow(groupMean - grandMean, 2);
                }
            });
            const SSW = SST - SSB;
            const dfBetween = k - 1;
            const dfWithin = totalN - k;
            const dfTotal = totalN - 1;
            const MSB = SSB / dfBetween;
            const MSW = SSW / dfWithin;
            const F = MSB / MSW;
            const alpha = parseFloat(document.getElementById('significanceLevel').value);
            const FCritical = getFCritical(dfBetween, dfWithin, alpha);
            let html = '<h4>' + itemName + ' ë¶„ì‚°ë¶„ì„í‘œ</h4>';
            html += '<table>';
            html += '<thead><tr>';
            html += '<th>ë³€ë™ìš”ì¸</th><th>ì œê³±í•©(SS)</th><th>ììœ ë„(df)</th>';
            html += '<th>í‰ê· ì œê³±(MS)</th><th>Fê°’</th><th>F ì„ê³„ê°’</th><th>ìœ ì˜ì„±</th>';
            html += '</tr></thead><tbody>';
            html += '<tr>';
            html += '<td>ì²˜ë¦¬ê°„ (í’ˆì¢…ê°„)</td>';
            html += `<td>${SSB.toFixed(2)}</td>`;
            html += `<td>${dfBetween}</td>`;
            html += `<td>${MSB.toFixed(2)}</td>`;
            html += `<td>${F.toFixed(3)}</td>`;
            html += `<td>${FCritical.toFixed(3)}</td>`;
            html += `<td>${F > FCritical ? '**' : 'ns'}</td>`;
            html += '</tr>';
            html += '<tr>';
            html += '<td>ì²˜ë¦¬ë‚´ (ì˜¤ì°¨)</td>';
            html += `<td>${SSW.toFixed(2)}</td>`;
            html += `<td>${dfWithin}</td>`;
            html += `<td>${MSW.toFixed(2)}</td>`;
            html += '<td>-</td>';
            html += '<td>-</td>';
            html += '<td>-</td>';
            html += '</tr>';
            html += '<tr style="font-weight: bold;">';
            html += '<td>ì „ì²´</td>';
            html += `<td>${SST.toFixed(2)}</td>`;
            html += `<td>${dfTotal}</td>`;
            html += '<td>-</td>';
            html += '<td>-</td>';
            html += '<td>-</td>';
            html += '<td>-</td>';
            html += '</tr>';
            html += '</tbody></table>';
            if (F > FCritical) {
                html += '<p class="alert alert-success">í’ˆì¢…ê°„ ìœ ì˜í•œ ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤ (p < ' + alpha + ')</p>';
            } else {
                html += '<p class="alert alert-info">í’ˆì¢…ê°„ ìœ ì˜í•œ ì°¨ì´ê°€ ì—†ìŠµë‹ˆë‹¤ (p â‰¥ ' + alpha + ')</p>';
            }
            document.getElementById('anovaResults').innerHTML = html;
        }

        function performDMRT(varietyData, itemName) {
            const alpha = parseFloat(document.getElementById('significanceLevel').value);
            const means = [];
            Object.keys(varietyData).forEach(variety => {
                const values = varietyData[variety];
                if (values.length > 0) {
                    const mean = values.reduce((a, b) => a + b, 0) / values.length;
                    means.push({
                        variety: variety,
                        mean: mean,
                        n: values.length,
                        values: values
                    });
                }
            });
            means.sort((a, b) => b.mean - a.mean);
            const groups = [];
            means.forEach((item, idx) => {
                let group = '';
                if (idx === 0) {
                    group = 'a';
                } else {
                    const diff = means[0].mean - item.mean;
                    const se = calculatePooledSE(varietyData);
                    const criticalDiff = se * 2.8;
                    if (diff > criticalDiff) {
                        group = String.fromCharCode(97 + Math.floor(diff / criticalDiff));
                    } else {
                        group = 'a';
                    }
                }
                groups.push({
                    ...item,
                    group: group
                });
            });
            let html = '<h4>' + itemName + ' Duncan ë‹¤ì¤‘ê²€ì • ê²°ê³¼</h4>';
            html += '<table>';
            html += '<thead><tr>';
            html += '<th>ìˆœìœ„</th><th>í’ˆì¢…</th><th>í‰ê· </th><th>ê·¸ë£¹</th>';
            html += '</tr></thead><tbody>';
            groups.forEach((item, idx) => {
                html += '<tr>';
                html += `<td>${idx + 1}</td>`;
                html += `<td><strong>${item.variety}</strong></td>`;
                html += `<td>${item.mean.toFixed(2)}</td>`;
                html += `<td style="font-weight: bold; color: #667eea;">${item.group}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            html += '<p class="alert alert-info">ê°™ì€ ë¬¸ìë¥¼ ê³µìœ í•˜ëŠ” í’ˆì¢…ê°„ì—ëŠ” ìœ ì˜í•œ ì°¨ì´ê°€ ì—†ìŠµë‹ˆë‹¤ (Î± = ' + alpha + ')</p>';
            document.getElementById('dmrtResults').innerHTML = html;
        }

        function calculatePooledSE(varietyData) {
            let totalSS = 0;
            let totalDF = 0;
            Object.keys(varietyData).forEach(variety => {
                const values = varietyData[variety];
                if (values.length > 1) {
                    const mean = values.reduce((a, b) => a + b, 0) / values.length;
                    const ss = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0);
                    totalSS += ss;
                    totalDF += (values.length - 1);
                }
            });
            const pooledVariance = totalSS / totalDF;
            const avgN = Object.values(varietyData).reduce((sum, v) => sum + v.length, 0) / Object.keys(varietyData).length;
            return Math.sqrt(pooledVariance / avgN);
        }

        function getFCritical(df1, df2, alpha) {
            if (alpha === 0.05) {
                if (df1 <= 5 && df2 >= 20) return 2.71;
                if (df1 <= 5 && df2 >= 10) return 3.48;
                if (df1 <= 10 && df2 >= 20) return 2.35;
                return 3.00;
            } else if (alpha === 0.01) {
                if (df1 <= 5 && df2 >= 20) return 4.10;
                if (df1 <= 5 && df2 >= 10) return 5.64;
                return 4.50;
            }
            return 3.00;
        }

        function updateChart() {
            const item = document.getElementById('analysisItem').value;
            const chartType = document.getElementById('chartType').value;
            const errorBarType = document.getElementById('errorBar').value;
            if (!item || !surveyData) return;
            const ctx = document.getElementById('analysisChart').getContext('2d');
            if (currentChart) {
                currentChart.destroy();
            }
            const varietyStats = [];
            const labels = [];
            Object.keys(surveyData).forEach(variety => {
                const values = surveyData[variety][item] || [];
                if (values.length > 0) {
                    const stats = calculateStatistics(values);
                    varietyStats.push(stats);
                    labels.push(variety);
                }
            });
            const means = varietyStats.map(s => s.mean);
            const errorBars = varietyStats.map(s => {
                switch(errorBarType) {
                    case 'se': return s.se;
                    case 'sd': return s.std;
                    case 'ci95': return s.se * 1.96;
                    default: return 0;
                }
            });
            const chartConfig = {
                type: chartType === 'box' ? 'bar' : chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: item,
                        data: means,
                        backgroundColor: 'rgba(102, 126, 234, 0.5)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        errorBars: errorBars
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    const stats = varietyStats[idx];
                                    return [
                                        `n: ${stats.n}`,
                                        `í‰ê· : ${stats.mean.toFixed(2)}`,
                                        `í‘œì¤€í¸ì°¨: ${stats.std.toFixed(2)}`,
                                        `CV: ${stats.cv.toFixed(1)}%`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: item
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'í’ˆì¢…'
                            }
                        }
                    }
                }
            };
            currentChart = new Chart(ctx, chartConfig);
        }

        function updateAnalysis() {
            updateChart();
        }

        function downloadChart() {
            if (!currentChart) {
                alert('ë‹¤ìš´ë¡œë“œí•  ì°¨íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const url = currentChart.toBase64Image();
            const a = document.createElement('a');
            a.href = url;
            a.download = 'í†µê³„ì°¨íŠ¸_' + getDateString() + '.png';
            a.click();
        }

        function exportAnalysisReport() {
            if (Object.keys(analysisData).length === 0) {
                alert('ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const wb = XLSX.utils.book_new();
            const summaryData = [['í•­ëª©', 'í‰ê· ', 'í‘œì¤€í¸ì°¨', 'CV(%)', 'ìµœì†Œ', 'ìµœëŒ€', 'ë²”ìœ„']];
            Object.keys(analysisData).forEach(item => {
                const stats = analysisData[item];
                summaryData.push([
                    item,
                    stats.mean.toFixed(2),
                    stats.std.toFixed(2),
                    stats.cv.toFixed(2),
                    stats.min.toFixed(2),
                    stats.max.toFixed(2),
                    stats.range.toFixed(2)
                ]);
            });
            const ws = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws, 'í†µê³„ìš”ì•½');
            XLSX.writeFile(wb, 'ë¶„ì„ë³´ê³ ì„œ_' + getDateString() + '.xlsx');
        }

        // ========== ë¼ë²¨ ì¶œë ¥ ê¸°ëŠ¥ ==========
        
        function updateLabelType() {
            const labelType = document.getElementById('labelType').value;
            if (labelType === 'display') {
                document.getElementById('displayLabelSettings').style.display = 'block';
                document.getElementById('barcodeLabelSettings').style.display = 'none';
            } else {
                document.getElementById('displayLabelSettings').style.display = 'none';
                document.getElementById('barcodeLabelSettings').style.display = 'block';
            }
        }

        function updateDisplaySizeInfo() {
            const size = document.getElementById('displayLabelSize').value;
            const recommendedSize = document.getElementById('recommendedSize');
            const sizeInfo = {
                small: 'ì†Œí˜•: 75mm Ã— 40mm',
                medium: 'ì¤‘í˜•: 75mm Ã— 50mm',
                large: 'ëª…ì°°ìš©: 150mm Ã— 75mm'
            };
            recommendedSize.innerHTML = sizeInfo[size];
            updateLabelPreview();
        }

        function handleBgImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const label = event.target.nextElementSibling;
            const fileSize = (file.size / 1024).toFixed(1);
            label.innerHTML = `<div style="color: #1976d2; font-weight: bold;">ğŸ–¼ï¸ ${file.name}</div><small style="color: #666;">${fileSize} KB ì—…ë¡œë“œë¨</small>`;
            const reader = new FileReader();
            reader.onload = function(e) {
                bgImageData = e.target.result;
                alert('ë°°ê²½ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                updateLabelPreview();
            };
            reader.readAsDataURL(file);
        }

        function resetBgImage() {
            bgImageData = null;
            document.getElementById('bgImageFile').value = '';
            updateLabelPreview();
            alert('ë°°ê²½ ì´ë¯¸ì§€ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function generateDisplayLabels() {
            const labelSize = document.getElementById('displayLabelSize').value;
            const layout = document.getElementById('displayLabelLayout').value;
            const names = document.getElementById('displayNames').value.trim();
            const info = document.getElementById('displayInfo1').value;
            const textColor = document.getElementById('textColor').value;
            const textBg = document.getElementById('textBg').value;
            const imageFit = document.getElementById('imageFit').value;
            if (!names) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            const nameList = names.split('\n').map(n => n.trim()).filter(n => n);
            let gridColumns = 1;
            if (layout === '2x4') gridColumns = 2;
            else if (layout === '2x5') gridColumns = 2;
            let html = `<div class="label-grid" style="grid-template-columns: repeat(${gridColumns}, 1fr);">`;
            nameList.forEach(name => {
                let bgStyle = '';
                if (bgImageData) {
                    bgStyle = `background-image: url(${bgImageData}); `;
                    switch(imageFit) {
                        case 'cover':
                            bgStyle += 'background-size: cover; background-position: center;';
                            break;
                        case 'contain':
                            bgStyle += 'background-size: contain; background-repeat: no-repeat; background-position: center;';
                            break;
                        case 'stretch':
                            bgStyle += 'background-size: 100% 100%;';
                            break;
                        case 'center':
                            bgStyle += 'background-size: auto; background-position: center; background-repeat: no-repeat;';
                            break;
                    }
                }
                let textBgClass = '';
                if (textBg === 'white') textBgClass = 'text-bg-white';
                else if (textBg === 'black') textBgClass = 'text-bg-black';
                else if (textBg === 'blur') textBgClass = 'text-bg-blur';
                if (labelSize === 'small') {
                    let nameSize = 36;
                    let descSize = 18;
                    if (name.length > 5) {
                        nameSize = Math.floor(36 * (5 / name.length));
                        nameSize = Math.max(nameSize, 16);
                    }
                    if (info && info.length >= 15) {
                        descSize = Math.floor(18 * (15 / info.length));
                        descSize = Math.max(descSize, 8);
                    }
                    html += `
                        <div class="display-label-item display-label-small" style="${bgStyle}">
                            <div class="display-label-content">
                                <div class="${textBgClass}">
                                    <div class="label-name" style="color: ${textColor}; font-size: ${nameSize}pt;">
                                        ${name}
                                    </div>
                                    ${info ? `<div class="label-desc" style="color: ${textColor}; font-size: ${descSize}pt;">(${info})</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (labelSize === 'medium') {
                    let nameSize = 36;
                    let descSize = 18;
                    if (name.length > 5) {
                        nameSize = Math.floor(36 * (5 / name.length));
                        nameSize = Math.max(nameSize, 16);
                    }
                    if (info && info.length >= 15) {
                        descSize = Math.floor(18 * (15 / info.length));
                        descSize = Math.max(descSize, 8);
                    }
                    html += `
                        <div class="display-label-item display-label-medium" style="${bgStyle}">
                            <div class="display-label-content">
                                <div class="${textBgClass}">
                                    <div class="label-name" style="color: ${textColor}; font-size: ${nameSize}pt;">
                                        ${name}
                                    </div>
                                    ${info ? `<div class="label-desc" style="color: ${textColor}; font-size: ${descSize}pt;">(${info})</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (labelSize === 'large') {
                    let nameSize = 72;
                    let orgSize = 24;
                    if (name.length > 4) {
                        nameSize = Math.floor(72 * (4 / name.length));
                        nameSize = Math.max(nameSize, 24);
                    }
                    if (info && info.length > 12) {
                        orgSize = Math.floor(24 * (12 / info.length));
                        orgSize = Math.max(orgSize, 12);
                    }
                    html += `
                        <div class="display-label-item display-label-large" style="${bgStyle}">
                            <div class="display-label-content">
                                <div class="${textBgClass}">
                                    <div class="label-name" style="color: ${textColor}; font-size: ${nameSize}pt;">
                                        ${name}
                                    </div>
                                    ${info ? `<div class="label-org" style="color: ${textColor}; font-size: ${orgSize}pt;">${info}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            html += '</div>';
            document.getElementById('labelPreview').innerHTML = html;
            document.getElementById('labelActions').style.display = 'flex';
        }

        function updateLabelPreview() {
            const labelType = document.getElementById('labelType').value;
            if (varieties.length > 0) {
                if (labelType === 'display') {
                    generateDisplayLabels();
                }
            }
        }

        function updateLabelSpec() {
            const spec = document.getElementById('labelSpec').value;
            const info = document.getElementById('labelSpecInfo');
            if (spec === '3106') {
                info.innerHTML = `
                    <strong>ğŸ“‹ í¼í… 3106 ë¼ë²¨ ê·œê²©</strong><br>
                    â€¢ ë¼ë²¨ í¬ê¸°: 64mm Ã— 34mm<br>
                    â€¢ ë°°ì—´: 3ì—´ Ã— 8í–‰ (A4 í•œ ì¥ì— 24ê°œ)<br>
                    â€¢ ì—¬ë°±: ìœ„/ì•„ë˜ 12mm, ì¢Œ/ìš° 5mm, ì—´ ê°„ê²© 2mm
                `;
            } else if (spec === '3105') {
                info.innerHTML = `
                    <strong>ğŸ“‹ í¼í… 3105 ë¼ë²¨ ê·œê²©</strong><br>
                    â€¢ ë¼ë²¨ í¬ê¸°: 64mm Ã— 39mm<br>
                    â€¢ ë°°ì—´: 3ì—´ Ã— 7í–‰ (A4 í•œ ì¥ì— 21ê°œ)<br>
                    â€¢ ì—¬ë°±: ìœ„/ì•„ë˜ 12mm, ì¢Œ/ìš° 5mm, ì—´ ê°„ê²© 2mm
                `;
            }
        }

        function showQRDataInput() {
            const input = document.getElementById('qrDataInput');
            input.style.display = input.style.display === 'none' ? 'block' : 'none';
        }

        function clearQRData() {
            qrLabelData = [];
            document.getElementById('qrDataText').value = '';
            document.getElementById('qrLabelFile').value = '';
            document.getElementById('qrLabelFile').nextElementSibling.innerHTML = `
                ğŸ“‚ QRë¼ë²¨ ë°ì´í„° ì—‘ì…€ ì—…ë¡œë“œ<br>
                <small>í’ˆì¢… ë° ê³„í†µ ëª©ë¡ì´ í¬í•¨ëœ íŒŒì¼</small>
            `;
            document.getElementById('labelPreview').innerHTML = '<div class="output-empty">ë¼ë²¨ ì„¤ì •ì„ ì™„ë£Œí•˜ê³  \'QRë¼ë²¨ ìƒì„±\' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>';
            document.getElementById('labelActions').style.display = 'none';
            alert('QRë¼ë²¨ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function downloadQRTemplate() {
            const wb = XLSX.utils.book_new();
            const data = [
                ['ì—°ë„', 'ì‹¤í—˜ì‹¤', 'ì‹œí—˜ë²ˆí˜¸', 'í’ˆì¢… ë° ê³„í†µ'],
                ['2024', '1', '001', 'í•œì•„ë¦„'],
                ['2024', '1', '001', 'ìƒˆì¼ë¯¸'],
                ['2024', '2', '000001', 'ì‚¼ê´‘'],
                ['2024', '2', '12345', 'ì°¸ë™ì§„'],
                ['2024', '3', '999', 'ì‹ ë™ì§„']
            ];
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws, 'QRë¼ë²¨ë°ì´í„°');
            XLSX.writeFile(wb, 'QRë¼ë²¨_í…œí”Œë¦¿.xlsx');
        }

        function handleQRLabelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const label = event.target.nextElementSibling;
            const fileSize = (file.size / 1024).toFixed(1);
            label.innerHTML = `<div style="color: #1976d2; font-weight: bold;">ğŸ“„ ${file.name}</div><small style="color: #666;">${fileSize} KB ì—…ë¡œë“œë¨</small>`;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    qrLabelData = [];
                    jsonData.forEach((row, index) => {
                        const year = String(row['ì—°ë„'] || '2024');
                        const lab = String(row['ì‹¤í—˜ì‹¤'] || '1');
                        const testNum = String(row['ì‹œí—˜ë²ˆí˜¸'] || '');
                        const variety = row['í’ˆì¢… ë° ê³„í†µ'] || row['í’ˆì¢…'] || '';
                        if (variety) {
                            const paddedTestNum = testNum.padStart(6, '0').substring(0, 6);
                            const sampleNumber = year + '0' + lab + paddedTestNum;
                            qrLabelData.push({
                                sampleNumber: sampleNumber,
                                testNumber: testNum,
                                variety: variety
                            });
                        }
                    });
                    alert(`${qrLabelData.length}ê°œì˜ ë¼ë²¨ ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`);
                } catch (error) {
                    alert('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function updateSampleNumberFormat() {
            const year = document.getElementById('sampleYear').value || '2024';
            const lab = document.getElementById('labCode').value || '1';
            const testNum = document.getElementById('testNumberInput').value || '';
            const paddedTestNum = testNum.padStart(6, '0').substring(0, 6);
            const sampleNumber = year + '0' + lab + paddedTestNum;
            const displayFormat = `${year} 0 ${lab} ${paddedTestNum}`;
            document.getElementById('sampleFormatExample').textContent = displayFormat;
            return sampleNumber;
        }

        function generateQRLabels() {
            const directInput = document.getElementById('qrDataText').value.trim();
            if (directInput && qrLabelData.length === 0) {
                const lines = directInput.split('\n').map(line => line.trim()).filter(line => line);
                qrLabelData = [];
                const year = document.getElementById('sampleYear').value || '2024';
                const lab = document.getElementById('labCode').value || '1';
                const testNum = document.getElementById('testNumberInput').value || '001';
                lines.forEach((variety, index) => {
                    if (variety) {
                        const paddedTestNum = testNum.padStart(6, '0').substring(0, 6);
                        const sampleNumber = year + '0' + lab + paddedTestNum;
                        qrLabelData.push({
                            sampleNumber: sampleNumber,
                            testNumber: testNum,
                            variety: variety
                        });
                    }
                });
            }
            if (qrLabelData.length === 0) {
                alert('í’ˆì¢… ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }
            const spec = document.getElementById('labelSpec').value;
            const isLarge = spec === '3105';
            let html = '<div class="barcode-label-container">';
            if (isLarge) {
                html += '<div class="barcode-label-grid-21">';
            } else {
                html += '<div class="barcode-label-grid">';
            }
            qrLabelData.forEach((data, idx) => {
                let testNumSize = 18;
                if (data.testNumber.length > 4) {
                    testNumSize = Math.floor(18 * (4 / data.testNumber.length));
                    testNumSize = Math.max(testNumSize, 12);
                }
                let varietySize = 9;
                if (data.variety.length > 10) {
                    varietySize = Math.floor(9 * (10 / data.variety.length));
                    varietySize = Math.max(varietySize, 6);
                }
                html += `
                    <div class="qr-label-item ${isLarge ? 'qr-label-item-39' : ''}">
                        <div class="qr-label-left">
                            <div id="qr-code-${idx}" class="qr-code-container"></div>
                        </div>
                        <div class="qr-label-right">
                            <div class="qr-test-number" style="font-size: ${testNumSize}pt;">${data.testNumber}</div>
                            <div class="qr-variety-name" style="font-size: ${varietySize}pt;">${data.variety}</div>
                            <div class="qr-sample-number">${data.sampleNumber}</div>
                        </div>
                    </div>
                `;
            });
            const maxLabels = isLarge ? 21 : 24;
            const remaining = maxLabels - (qrLabelData.length % maxLabels);
            if (remaining < maxLabels) {
                for (let i = 0; i < remaining; i++) {
                    html += `<div class="qr-label-item ${isLarge ? 'qr-label-item-39' : ''}" style="border: 1px dashed #ddd;"></div>`;
                }
            }
            html += '</div></div>';
            document.getElementById('labelPreview').innerHTML = html;
            setTimeout(() => {
                qrLabelData.forEach((data, idx) => {
                    const qrElement = document.getElementById(`qr-code-${idx}`);
                    if (qrElement) {
                        qrElement.innerHTML = '';
                        new QRCode(qrElement, {
                            text: data.sampleNumber,
                            width: 75,
                            height: 75,
                            typeNumber: 0,
                            correctLevel: QRCode.CorrectLevel.M,
                            colorDark: "#000000",
                            colorLight: "#ffffff"
                        });
                    }
                });
            }, 100);
            document.getElementById('labelActions').style.display = 'flex';
            alert('QRë¼ë²¨ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function printLabels() {
            window.print();
        }

        function downloadLabelsPDF() {
            alert('PDF ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì€ ì„œë²„ í™˜ê²½ì—ì„œ êµ¬í˜„ë©ë‹ˆë‹¤.\ní˜„ì¬ëŠ” ì¸ì‡„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
        }

        function downloadLabelsExcel() {
            if (varieties.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const wb = XLSX.utils.book_new();
            const info1 = document.getElementById('displayInfo1').value;
            const data = [['í’ˆì¢…', 'ì¶”ê°€ì •ë³´']];
            varieties.forEach(v => {
                data.push([v.full, info1]);
            });
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'ë¼ë²¨');
            XLSX.writeFile(wb, 'ë¼ë²¨_' + getDateString() + '.xlsx');
        }

        // ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ==========

        function getDateString() {
            const now = new Date();
            return now.getFullYear() + 
                   String(now.getMonth() + 1).padStart(2, '0') + 
                   String(now.getDate()).padStart(2, '0');
        }

        function getMedian(values) {
            const sorted = values.slice().sort((a, b) => a - b);
            const middle = Math.floor(sorted.length / 2);
            if (sorted.length % 2 === 0) {
                return (sorted[middle - 1] + sorted[middle]) / 2;
            }
            return sorted[middle];
        }
    </script>
</body>
</html>
